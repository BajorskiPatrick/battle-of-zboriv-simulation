\chapter{MODEL FORMALNY} \label{ch:procedure}

\section{Szczegółowy model zachowania agenta}

Logika decyzyjna każdego agenta (\textit{MilitaryAgent}) jest wykonywana w każdej turze symulacji. Proces ten jest deterministyczno-stochastyczny: reguły są stałe, ale ich wynik zależy od rzutów prawdopodobieństwa (np. test morale, szansa na trafienie).

W modelu zaimplementowano zaawansowane mechanizmy psychologii tłumu, symulujące efekt domina na polu bitwy:
\begin{itemize}
    \item \textbf{Panika Łańcuchowa (Chain Panic):} Gdy jednostka nie zda testu morale i rzuci się do ucieczki, wywołuje to falę strachu u pobliskich sojuszników (w promieniu 3 pól), obniżając ich morale. Siła tego efektu jest tym mniejsza, im większa jest dyscyplina obserwatorów (dla zdyscyplinowanych żołnierzy efekt ten jest zerowy).
    \item \textbf{Panika po Śmierci (Death Panic):} Eliminacja jednostki wywołuje silny wstrząs psychiczny u towarzyszy znajdujących się w bezpośrednim sąsiedztwie, co może prowadzić do załamania całej formacji, nawet jeśli nie była ona bezpośrednio atakowana. Siła tego efektu zależy od dyscypliny analogicznie, jak w przypadku Paniki Łańcuchowej.
\end{itemize}

Poniżej przedstawiono kompletny algorytm cyklu życia agenta (Algorytm \ref{alg:main_loop}), procedurę obsługi obrażeń (Algorytm \ref{alg:receive_damage}) oraz dedykowaną procedurę obsługi ucieczki (Algorytm \ref{alg:fleeing}).

\begin{algorithm}[H]
\caption{\small{\texttt{Główna pętla decyzyjna agenta (Step)}}
\label{alg:main_loop}}
\begin{algorithmic}[1]
\REQUIRE Agent $A$, Grid $G$, Weather $W$
\IF{$A.HP \le 0$} \RETURN \ENDIF
\STATE Zmniejsz $A.fire\_cooldown$ jeśli $> 0$
\STATE $PanicThreshold \gets 25 - (A.Discipline / 5)$
\IF{$A.Morale < PanicThreshold$ \AND $A.State \neq FLEEING$}
    \IF{$Random(0, 100) > A.Discipline$}
        \STATE $A.State \gets FLEEING$
        \STATE \textbf{Call} \textsc{TriggerChainPanic}($A$)
        \STATE \textbf{Call} \textsc{ManageFleeing}($A$)
    \ENDIF
\ENDIF

\IF{$A.State == FLEEING$}
    \IF{brak ścieżki \AND Frakcja == "Armia Koronna"}
        \STATE \textbf{Call} \textsc{ManageFleeing}($A$) \COMMENT{Przelicz cel ucieczki}
    \ENDIF
    \STATE \textbf{Call} \textsc{Move}($A$)
    \RETURN
\ENDIF

\STATE $Enemy \gets$ \textsc{FindEnemy}($A$, radius=$W.visibility$)

\IF{$Enemy$ istnieje}
    \STATE $Dist \gets$ \textsc{Distance}($A$, $Enemy$)
    \IF{$1 < Dist \le A.Range$ \AND $A.RangedDmg > 0$}
        \STATE $Misfire \gets 0.4$ jeśli $W == Rain$ wpp. $0.0$
        \IF{$A.Ammo > 0$}
            \IF{$A.Cooldown \le 0$ \AND $Random() > Misfire$}
                \STATE $A.State \gets ATTACKING$
                \STATE $A.Ammo \gets A.Ammo - 1$
                \STATE \textsc{ReceiveDamage}($Enemy$, $A.RangedDmg$)
            \ENDIF
        \ELSE
             \STATE \textsc{PathTo}($Enemy$) \COMMENT{Brak amunicji, szarża}
             \STATE \textsc{Move}($A$)
        \ENDIF
    \ELSIF{$Dist \le 1.5$}
        \STATE $A.State \gets ATTACKING$
        \STATE \textsc{ReceiveDamage}($Enemy$, $A.MeleeDmg$) \COMMENT{Walka wręcz}
    \ELSE
        \STATE \textsc{PathTo}($Enemy$)
        \STATE \textsc{Move}($A$)
    \ENDIF
\ELSE
    \STATE $A.State \gets MOVING\_TO\_STRATEGIC$
    \STATE \textsc{PathTo}($A.StrategicTarget$)
    \STATE \textsc{Move}($A$)
\ENDIF
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[H]
\caption{\small{\texttt{Procedura otrzymania obrażeń (Receive Damage)}}
\label{alg:receive_damage}}
\begin{algorithmic}[1]
\REQUIRE Agent $A$, Damage $D$
\STATE $Reduction \gets Random(0, A.Defense / 2)$
\STATE $ActualDmg \gets \max(1, D - Reduction)$
\STATE $A.HP \gets A.HP - ActualDmg$
\STATE $MoraleLoss \gets ActualDmg \times 1.5$
\IF{$A.Discipline > 80$}
    \STATE $MoraleLoss \gets MoraleLoss \times 0.7$
\ENDIF
\STATE $A.Morale \gets A.Morale - MoraleLoss$

\IF{$A.HP \le 0$}
    \STATE \textbf{Call} \textsc{TriggerDeathPanic}($A$)
    \STATE Oznacz agenta jako martwego
\ENDIF
\end{algorithmic}
\end{algorithm}

\section{Algorytm ucieczki i regeneracji}

Unikalnym elementem modelu jest zróżnicowana strategia ucieczki. Jednostki Kozackie zawsze uciekają do krawędzi mapy. Jednostki Koronne podejmują decyzję: jeśli Obóz (Centrum Leczenia) jest bliżej niż krawędź mapy i posiada wolne miejsca, agent spróbuje się tam schronić, aby zregenerować siły (HP i Morale).

\begin{algorithm}[H]
\caption{\small{\texttt{Procedura wyznaczania celu ucieczki (Manage Fleeing)}}
\label{alg:fleeing}}
\begin{algorithmic}[1]
\REQUIRE Agent $A$, Grid $G$
\STATE $CurrentPos \gets A.Position$
\STATE $DistToEdge \gets$ minimum dystansu do krawędzi (L, R, T, B)

\IF{$A.Faction ==$ "Armia Koronna"}
    \STATE $TargetCenter \gets$ Najbliższe \textbf{niezapełnione} Centrum Leczenia
    \STATE $ShouldFleeToEdge \gets True$
    
    \IF{$TargetCenter$ istnieje}
        \STATE $DistToCenter \gets$ \textsc{Distance}($CurrentPos$, $TargetCenter$)
        \IF{$DistToCenter \le 2 \times DistToEdge$}
            \STATE $ShouldFleeToEdge \gets False$
        \ENDIF
    \ENDIF
    
    \IF{NOT $ShouldFleeToEdge$}
        \STATE $Entrance \gets$ \textsc{GetEntrance}($TargetCenter$)
        \IF{$CurrentPos$ na $Entrance$}
            \STATE Wejdź głębiej w strefę leczenia
        \ELSE
            \STATE \textsc{CalculatePath}($Entrance$)
        \ENDIF
    \ELSE
        \STATE \textsc{CalculatePath}(Najbliższa Krawędź Mapy)
    \ENDIF
\ELSE
    \STATE \textsc{CalculatePath}(Najbliższa Krawędź Mapy)
\ENDIF
\end{algorithmic}
\end{algorithm}